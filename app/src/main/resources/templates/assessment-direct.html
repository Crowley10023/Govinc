<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <meta charset="UTF-8">
    <title>Assessment Direct Link</title>
    <link rel="stylesheet" href="/style.css">
</head>

<body>
    <main class="container">
        <div th:if="${assessment.status == 'CLOSED'}">
            <h1>SORRY NOT LONGER AVAILABLE</h1>
        </div>
        <div th:if="${assessment.status != 'CLOSED'}">
            <h1>Assessment (Direct URL)</h1>
            <section>
                <h2 th:text="${assessment.name}"></h2>
                <table class="table card">
                    <tr>
                        <th>Date</th>
                        <td th:text="${assessment.date}"></td>
                    </tr>
                    <tr>
                        <th>Security Catalog</th>
                        <td th:text="${assessment.securityCatalog.name}"></td>
                    </tr>
                    <tr>
                        <th>Status</th>
                        <td th:text="${assessment.status}"></td>
                    </tr>
                </table>
            </section>
            <section>
                <h2>Summary of Answers</h2>
                <table class="table card" style="margin-bottom: 2em;">
                    <thead>
                        <tr>
                            <th>Answer Category</th>
                            <th>Count</th>
                            <th>Percent (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:if="${answerSummary == null || answerSummary.isEmpty()}">
                            <td colspan="3">No answers yet</td>
                        </tr>
                        <tr th:each="entry : ${answerSummary}">
                            <td th:text="${entry.key}"></td>
                            <td th:text="${entry.value.count}"></td>
                            <td th:text="${#numbers.formatDecimal(entry.value.percent, 0, 2)}"></td>
                        </tr>
                    </tbody>
                </table>
        </div>
        <h2>Controls &amp; Answers</h2>
        <!-- START Group by SecurityControlDomain, make collapsible -->
        <div th:text="'Domains size: ' + ${#lists.size(securityControlDomains)}"></div>
        <div th:each="domain : ${securityControlDomains}">
            <div class="domain-header" onclick="toggleDomain(this)"
                style="cursor:pointer;font-weight:bold;margin-top:1.5em;padding:0.5em 0;background:#daf0ff;border-radius:6px;">
                <span th:text="${domain != null ? domain.name : 'No Domain'}"></span>
                <span style="font-weight:normal;padding-left:14px;color:#777;"
                    th:text="${domain != null ? domain.description : ''}"></span>
                <span style="float:right;">[<span>Show/Hide</span>]</span>
            </div>
            <div class="domain-controls" style="display:none;">
                <div th:if="${assessment.isOpen}">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Control</th>
                                <th>Answer</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="ctrl : ${assessment.securityCatalog.securityControls}">
                                <th:block
                                    th:if="${ctrl.securityControlDomain != null && domain != null && ctrl.securityControlDomain.id == domain.id}">
                                    <td>
                                        <div class="ctrl-desc-wrap">
                                            <span th:text="${ctrl.name}"></span>
                                            <button type="button" class="ctrl-desc-btn" tabindex="0"
                                                title="Show description" onclick="toggleDesc(this)">
                                                <svg viewBox="0 0 24 24">
                                                    <circle cx="12" cy="12" r="10" fill="#fff" stroke="#2274A5"
                                                        stroke-width="2" /><text x="12" y="17" text-anchor="middle"
                                                        font-family="Arial,Helvetica,sans-serif" font-size="15" dy="-2"
                                                        fill="#2274A5">?</text>
                                                </svg>
                                            </button>
                                            <div class="ctrl-desc-tooltip">
                                                <b>Description:</b>
                                                <div th:utext="${#strings.escapeXml(ctrl.detail) ?: 'No detail'}"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span style="white-space:nowrap;">
                                            <select th:name="${'control_' + ctrl.id}" th:data-control-id="${ctrl.id}"
                                                class="answer-select">
                                                <option value="">-- select an answer --</option>
                                                <option th:each="ans : ${maturityAnswers}" th:value="${ans.id}"
                                                    th:selected="${controlAnswers != null and controlAnswers[ctrl.id] != null} ? ${ans.answer} == ${controlAnswers[ctrl.id]} : false"
                                                    th:text="${ans.answer}"></option>
                                            </select>
                                            <span class="answer-feedback"></span>
                                        </span>
                                    </td>
                                </th:block>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div th:if="${!assessment.isOpen}">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Control</th>
                                <th>Answer</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="ctrl : ${assessment.securityCatalog.securityControls}">
                                <th:block
                                    th:if="${ctrl.securityControlDomain != null && domain != null && ctrl.securityControlDomain.id == domain.id}">
                                    <td>
                                        <div class="ctrl-desc-wrap">
                                            <span th:text="${ctrl.name}"></span>
                                            <button type="button" class="ctrl-desc-btn" tabindex="0"
                                                title="Show description" onclick="toggleDesc(this)">
                                                <svg viewBox="0 0 24 24">
                                                    <circle cx="12" cy="12" r="10" fill="#fff" stroke="#2274A5"
                                                        stroke-width="2" /><text x="12" y="17" text-anchor="middle"
                                                        font-family="Arial,Helvetica,sans-serif" font-size="15" dy="-2"
                                                        fill="#2274A5">?</text>
                                                </svg>
                                            </button>
                                            <div class="ctrl-desc-tooltip">
                                                <b>Description:</b>
                                                <div th:utext="${#strings.escapeXml(ctrl.detail) ?: 'No detail'}"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span
                                            th:text="${controlAnswers != null and controlAnswers[ctrl.id] != null ? controlAnswers[ctrl.id] : 'No answer'}"></span>
                                    </td>
                                </th:block>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <script>
            function toggleDomain(header) {
                var controlsDiv = header.nextElementSibling;
                if (controlsDiv.style.display === 'none' || controlsDiv.style.display === '') {
                    controlsDiv.style.display = 'block';
                } else {
                    controlsDiv.style.display = 'none';
                }
            }
        </script>
        </section>
        </div> <!-- end not CLOSED div -->
    </main>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            let assessmentId = /*[[${assessment.id}]]*/[[${ assessment.id }]];
            function showSuccessIcon(container) {
                container.html('<span class="answer-success" title="Saved"><svg viewBox="0 0 18 18"><circle cx="9" cy="9" r="8" fill="#d8ffd8" stroke="#33aa33" stroke-width="2"/><path d="M5 9l3 3 5-5" fill="none" stroke="#33aa33" stroke-width="2"/></svg></span>');
            }
            function showErrorIcon(container) {
                container.html('<span class="answer-error" title="Error saving"><svg viewBox="0 0 18 18"><circle cx="9" cy="9" r="8" fill="#ffd8d8" stroke="#cc2222" stroke-width="2"/><path d="M6 6l6 6M12 6l-6 6" fill="none" stroke="#cc2222" stroke-width="2"/></svg></span>');
            }
            function clearIcon(container) {
                container.empty();
            }
            $('.answer-select').on('change', function () {
                var select = $(this);
                var controlId = select.data('control-id');
                var answerId = select.val();
                var feedbackIcon = select.closest('span').find('.answer-feedback');
                select.css('background', ''); // reset
                clearIcon(feedbackIcon);
                if (!answerId) {
                    clearIcon(feedbackIcon);
                    return;
                }
                if (assessmentId && controlId) {
                    $.post({
                        url: '/assessment/' + assessmentId + '/answer',
                        data: {
                            controlId: controlId,
                            answerId: answerId
                        },
                        success: function (response) {
                            select.css('background', '#d8ffd8');
                            showSuccessIcon(feedbackIcon);
                            setTimeout(function () { clearIcon(feedbackIcon); select.css('background', ''); }, 1500);
                        },
                        error: function (xhr) {
                            select.css('background', '#ffd8d8');
                            showErrorIcon(feedbackIcon);
                        }
                    });
                }
            });
        });
    </script>

    <style>
        .answer-feedback {
            display: inline-block;
            width: 20px;
            height: 20px;
            vertical-align: middle;
            margin-left: 5px;
        }

        .answer-feedback svg {
            width: 18px;
            height: 18px;
        }

        .answer-success {
            color: #33aa33;
        }

        .answer-error {
            color: #cc2222;
        }
    </style>
    <style>
        .ctrl-desc-tooltip-icon {
            display: inline-block;
            position: relative;
            cursor: pointer;
        }

        .ctrl-desc-tooltip-icon svg {
            vertical-align: middle;
        }

        .ctrl-desc-tooltip {
            visibility: hidden;
            opacity: 0;
            background: #fffbe8;
            color: #333;
            border: 1px solid #d4cead;
            border-radius: 5px;
            padding: 12px 15px;
            min-width: 240px;
            max-width: 300px;
            position: absolute;
            left: 30px;
            top: -10px;
            z-index: 99;
            box-shadow: 0 0 10px 2px #0001;
            transition: opacity 0.24s, visibility 0.24s;
            font-size: 0.95em;
            line-height: 1.3em;
            text-align: left;
            white-space: normal;
        }

        /* Show the tooltip on hover or focus */
        .ctrl-desc-tooltip-icon:hover .ctrl-desc-tooltip,
        .ctrl-desc-tooltip-icon:focus .ctrl-desc-tooltip,
        .ctrl-desc-tooltip-icon:focus-within .ctrl-desc-tooltip {
            visibility: visible;
            opacity: 1;
        }
    </style>
</body>

</html>