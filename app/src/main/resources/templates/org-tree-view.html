<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Organization Tree View</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        .org-svg-tree {
            width: 100%;
            min-height: 500px;
        }

        .org-node {
            fill: #f7fafc;
            stroke: #4682b4;
            stroke-width: 2;
            rx: 6;
        }

        .org-label {
            font-family: Arial, sans-serif;
            font-size: 16px;
            fill: #2c3e50;
            font-weight: bold;
            text-anchor: middle;
            alignment-baseline: middle;
        }

        .org-link {
            stroke: #b0b0b0;
            stroke-width: 2;
        }
        .expand-btn {
            cursor: pointer;
            fill: #4682b4;
            user-select: none;
        }
    </style>
</head>

<body>
    <div th:replace="navigation :: mainNav"></div>
    <h1>Org Unit Tree View</h1>
    <div th:if="${orgUnit == null}">
        <p>No organization unit found for this ID.</p>
    </div>
    <div th:if="${orgUnit != null}">
        <div style="width: 100%; overflow-x: auto;">
            <svg id="orgTreeSvg" class="org-svg-tree" xmlns="http://www.w3.org/2000/svg" height="800" width="1600"></svg>
        </div>
        <a th:href="@{'/orgunits/list'}">&larr; Back to Org Units List</a>
    </div>

    <!-- SVG Node Fragment (no recursion, AJAX on demand) -->
    <th:block th:fragment="svgNodeFragmentAjax(node, x, y, depth, width, treeSpacing, levelHeight)">
        <th:block th:if="${node != null}">
            <g th:attr="id='node-' + ${node.id}">
                <!-- Node rectangle -->
                <rect th:x="${x-60}" th:y="${y}" width="120" height="40" class="org-node" />
                <text th:x="${x}" th:y="${y+22}" class="org-label" th:text="${node.name}"></text>

                <!-- Expand/collapse button if hasChildren -->
                <g th:if="${node.hasChildren}" th:attr="id='expander-'+${node.id}">
                    <circle th:attr="cx=${x+70}, cy=${y+20}, r=10" class="expand-btn" />
                    <text th:attr="x=${x+70}, y=${y+25}" font-size="16" fill="#fff" text-anchor="middle"
                        class="expand-btn" style="pointer-events:none;">&#9654;</text>
                </g>

                <!-- Place for dynamically loaded children -->
                <g th:attr="id='children-'+${node.id}" />

                <!-- Example: connecting lines JS will add on expansion -->
            </g>
        </th:block>
    </th:block>

    <script>
        // Fetch full org tree at once, then render the whole tree immediately.
        document.addEventListener('DOMContentLoaded', function () {
            // Replace {rootId} below with actual root id (available as a JS variable or data attribute)
            const rootId = "[[${orgUnit != null ? orgUnit.id : ''}]]";
            if (!rootId) return;
            fetch(`/orgunits/tree/${rootId}/fulltree`)
                .then(resp => resp.json())
                .then(tree => {
                    drawOrgTreeFull(tree, 800, 40, 0, 1600);
                });
        });

        function drawOrgTreeFull(root, svgWidth, startY, level, svgDisplayWidth) {
            const svg = document.getElementById('orgTreeSvg');
            svg.innerHTML = '';
            const nodeW = 120, nodeH = 40, hSpacing = 160, vSpacing = 90;
            // Compute tree width recursively
            function computeSubtreeWidth(node) {
                if (!node.children || node.children.length === 0) return 1;
                return node.children.map(computeSubtreeWidth).reduce((a,b)=>a+b,0);
            }
            // Position nodes, store {node, x, y, subtreeWidth}
            let positions = [];
            function layout(node, depth, left, width) {
                const sw = computeSubtreeWidth(node);
                const nodeX = left + width/2;
                const nodeY = startY + depth*vSpacing;
                positions.push({ node, x: nodeX, y: nodeY, subtreeWidth: sw });
                if (node.children && node.children.length) {
                    // Allocate width proportional to subtree widths?
                    let total = node.children.map(computeSubtreeWidth)
                                 .reduce((a,b)=>a+b,0);
                    let curX = left;
                    node.children.forEach(child => {
                        const w = width * computeSubtreeWidth(child) / total;
                        layout(child, depth+1, curX, w);
                        curX += w;
                    });
                }
            }
            layout(root, level, 0, svgDisplayWidth);
            // Draw links
            positions.forEach(pos => {
                if (pos.node.children && pos.node.children.length) {
                    pos.node.children.forEach(child => {
                        const target = positions.find(p=>p.node.id===child.id);
                        if (target) {
                            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                            line.setAttribute('x1', pos.x);
                            line.setAttribute('y1', pos.y+nodeH);
                            line.setAttribute('x2', target.x);
                            line.setAttribute('y2', target.y);
                            line.classList.add('org-link');
                            svg.appendChild(line);
                        }
                    });
                }
            });
            // Draw nodes
            positions.forEach(pos => {
                const nodeGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                nodeGroup.setAttribute('id', 'node-'+pos.node.id);
                // Rectangle
                const r = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                r.setAttribute('x', pos.x-nodeW/2);
                r.setAttribute('y', pos.y);
                r.setAttribute('width', nodeW);
                r.setAttribute('height', nodeH);
                r.classList.add('org-node');
                nodeGroup.appendChild(r);
                // Label
                const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                t.setAttribute('x', pos.x);
                t.setAttribute('y', pos.y+nodeH/2+6);
                t.classList.add('org-label');
                t.textContent = pos.node.name;
                nodeGroup.appendChild(t);
                svg.appendChild(nodeGroup);
            });
        }
    </script>
</body>

</html>
