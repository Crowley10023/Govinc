<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Assessment Details</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        .answer-feedback {
            display: inline-block;
            width: 20px;
            height: 20px;
            vertical-align: middle;
            margin-left: 5px;
        }

        .answer-feedback svg {
            width: 18px;
            height: 18px;
        }

        .answer-success {
            color: #33aa33;
        }

        .answer-error {
            color: #cc2222;
        }

        .ctrl-desc-btn {
            background: none;
            border: none;
            padding: 0 2px;
            cursor: pointer;
            vertical-align: middle;
        }

        .ctrl-desc-btn svg {
            width: 18px;
            height: 18px;
            fill: #2274A5;
            filter: drop-shadow(0 0 4px rgba(34, 116, 165, 0.22));
            transition: fill 0.2s;
        }

        .ctrl-desc-btn:hover svg {
            fill: #FF9505;
        }

        .ctrl-desc-tooltip {
            display: none;
            position: absolute;
            left: 44px;
            z-index: 20;
            max-width: 320px;
            background: linear-gradient(94deg, #fffbe7 90%, #ffe6d1 100%);
            color: #333;
            border: 1.5px solid #ffe3ad;
            box-shadow: 0 6px 24px rgba(255, 205, 58, 0.25), 0 1.5px 0px 1.5px #ffd995;
            padding: 0.7em 1em;
            border-radius: 10px;
            font-size: 0.96em;
            margin-top: 0.25em;
            animation: fadeInDesc 0.23s;
        }

        @keyframes fadeInDesc {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }

            to {
                opacity: 1;
                transform: none;
            }
        }

        .ctrl-desc-wrap {
            position: relative;
            display: inline-block;
            width: 100%;
        }
    </style>
</head>

<body>
    <div th:replace="navigation :: mainNav"></div>
    <main class="container">
        <h1>Assessment Details</h1>
        <section>
            <h2 th:text="${assessment.name}"></h2>
            <table class="table card">
                <tr>
                    <th>Date</th>
                    <td th:text="${assessment.date}"></td>
                </tr>
                <tr>
                    <th>Security Catalog</th>
                    <td th:text="${assessment.securityCatalog.name}"></td>
                </tr>
                <tr>
                    <th>Status</th>
                    <td th:text="${assessment.status}"></td>
                </tr>
                <tr>
                    <th>Assessment URL</th>
                    <td>
                        <span th:if="${assessment.assessmentUrls != null && assessment.assessmentUrls.url != null}">
                            <a th:href="@{'/assessment-direct/' + ${assessment.assessmentUrls.url}}" th:text="'/assessment-direct/' + ${assessment.assessmentUrls.url}" target="_blank"></a>
                        </span>
                        <span th:if="${assessment.assessmentUrls == null || assessment.assessmentUrls.url == null}">Not set</span>
                    </td>
                </tr>
                <tr>
                    <th>Predecessor Assessment</th>
                    <td>
                        <form th:action="@{'/assessment/' + ${assessment.id} + '/set-predecessor'}" method="post">
                            <select name="predecessorId">
                                <option value="" th:selected="${assessment.predecessor == null}">-- None --</option>
                                <option th:each="a : ${allAssessments}"
                                        th:value="${a.id}"
                                        th:selected="${assessment.predecessor != null and assessment.predecessor.id == a.id}"
                                        th:text="${a.name + ' (' + a.id + ')'}"
                                        th:if="${a.id != assessment.id}"></option>
                            </select>
                            <button type="submit">Set Predecessor</button>
                        </form>
                    </td>
                </tr>
                <tr>
                    <th>Users</th>
                    <td>
                        <span th:if="${!assessment.isOpen}">
                            <span th:if="${assessment.users == null || #lists.isEmpty(assessment.users)}">None</span>
                            <span th:each="user : ${assessment.users}" th:text="${user.name + ' (' + user.email + ')'} + ', '"></span>
                        </span>
                        <span th:if="${assessment.isOpen}">
                            <form th:action="@{'/assessment/' + ${assessment.id} + '/update-users'}" method="post" style="display:inline;">
                                <select name="userIds" multiple>
                                    <option th:each="user : ${users}"
                                            th:value="${user.id}"
                                            th:selected="${assessment.users.contains(user)}"
                                            th:text="${user.name + ' (' + user.email + ')'}"></option>
                                </select>
                                <button type="submit">Update Users</button>
                            </form>
                        </span>
                    </td>
                </tr>
            </table>

        </section>
        <section>
            <h2>Summary of Answers</h2>
            <table class="table card" style="margin-bottom: 2em;">
                <thead>
                    <tr>
                        <th>Answer Category</th>
                        <th>Count</th>
                        <th>Percent (%)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:if="${answerSummary == null || answerSummary.isEmpty()}">
                        <td colspan="3">No answers yet</td>
                    </tr>
                    <tr th:each="entry : ${answerSummary}">
                        <td th:text="${entry.key}"></td>
                        <td th:text="${entry.value.count}"></td>
                        <td th:text="${#numbers.formatDecimal(entry.value.percent, 0, 2)}"></td>
                    </tr>
                </tbody>
            </table>

            <h2>Controls &amp; Answers</h2>
            <!-- Editable/Active Assessment: Show sticky header above scroll -->
            <div th:if="${assessment.isOpen}">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Control</th>
                            <th>Answer</th>
                        </tr>
                    </thead>
                </table>
                <div class="controls-scroll-wrapper">
                    <table class="table">
                        <tbody>
                            <tr th:each="ctrl : ${assessment.securityCatalog.securityControls}">
                                <td>
                                    <div class="ctrl-desc-wrap">
                                        <span th:text="${ctrl.name}"></span>
                                        <button type="button" class="ctrl-desc-btn" tabindex="0"
                                            title="Show description" onclick="toggleDesc(this)">
                                            <svg viewBox="0 0 24 24">
                                                <circle cx="12" cy="12" r="10" fill="#fff" stroke="#2274A5"
                                                    stroke-width="2" /><text x="12" y="17" text-anchor="middle"
                                                    font-family="Arial,Helvetica,sans-serif" font-size="15" dy="-2"
                                                    fill="#2274A5">?</text>
                                            </svg>
                                        </button>
                                        <div class="ctrl-desc-tooltip">
                                            <b>Description:</b>
                                            <div th:utext="${#strings.escapeXml(ctrl.detail) ?: 'No detail'}"></div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span style="white-space:nowrap;" th:if="${assessment.isOpen}">
                                        <select th:name="${'control_' + ctrl.id}" th:data-control-id="${ctrl.id}"
                                            class="answer-select">
                                            <option value="">-- select an answer --</option>
                                            <option th:each="ans : ${maturityAnswers}" th:value="${ans.id}"
                                                th:selected="${controlAnswers[ctrl.id] != null} ? ${ans.answer} == ${controlAnswers[ctrl.id]} : false"
                                                th:text="${ans.answer}"></option>
                                        </select>
                                        <span class="answer-feedback"></span>
                                    </span>
                                    <span th:if="${assessment.status} == 'CLOSED'">
                                        <span
                                            th:text="${#lists.contains(answers.^map(a -> a.answer), controlAnswers[ctrl.id]) ? controlAnswers[ctrl.id] : (controlAnswers[ctrl.id] != null ? controlAnswers[ctrl.id] : 'No answer')}"></span>
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- CLOSED Assessment: Show static header above table -->
            <div th:if="${!assessment.isOpen}">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Control</th>
                            <th>Answer</th>
                        </tr>
                    </thead>
                </table>
                <div class="controls-scroll-wrapper">
                    <table class="table">
                        <tbody>
                            <tr th:each="ctrl : ${assessment.securityCatalog.securityControls}">
                                <td>
                                    <div class="ctrl-desc-wrap">
                                        <span th:text="${ctrl.name}"></span>
                                        <button type="button" class="ctrl-desc-btn" tabindex="0"
                                            title="Show description" onclick="toggleDesc(this)">
                                            <svg viewBox="0 0 24 24">
                                                <circle cx="12" cy="12" r="10" fill="#fff" stroke="#2274A5"
                                                    stroke-width="2" /><text x="12" y="17" text-anchor="middle"
                                                    font-family="Arial,Helvetica,sans-serif" font-size="15" dy="-2"
                                                    fill="#2274A5">?</text>
                                            </svg>
                                        </button>
                                        <div class="ctrl-desc-tooltip">
                                            <b>Description:</b>
                                            <div
                                                th:utext="${#strings.escapeXml(ctrl.detail) != null ? #strings.escapeXml(ctrl.detail) : 'No description'}">
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span
                                        th:text="${controlAnswers[ctrl.id] != null ? controlAnswers[ctrl.id] : 'No answer'}"></span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        <section class="actions-row action-buttons-flex">
            <div th:if="${assessment.isOpen}">
                <form th:action="@{'/assessment/' + ${assessment.id} + '/finalize'}" method="post">
                    <button type="submit"
                        onclick="return confirm('Are you sure you want to finalize this assessment? All edits will be locked.')">Finalize</button>
                </form>
            </div>
            <form th:action="@{'/assessment/' + ${assessment.id} + '/delete'}" method="post">
                <button type="submit"
                    onclick="return confirm('Are you sure you want to delete this assessment?')">Delete</button>
            </form>
            <form th:action="@{'/assessment/' + ${assessment.id} + '/report'}" method="get">
                <button type="submit">Create Report (PDF)</button>
            </form>
            <form th:action="@{'/assessment/' + ${assessment.id} + '/excel'}" method="get">
                <button type="submit">Export to Excel</button>
            </form>
        </section>
        <!-- Create URL Button Section -->
        <section>
            <button id="create-url-btn" type="button">Create URL</button>
            <span id="create-url-feedback"></span>
            <div id="direct-url-row" style="margin-top:8px; display:none;">
                <strong>Direct assessment link:</strong> <a id="direct-url-link" href="#" target="_blank"></a>
            </div>
        </section>
        <div class="nav-back">
            <a href="/assessment/list">&larr; Back to list</a>
        </div>
    </main>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            // Create URL button logic
            $("#create-url-btn").click(function () {
                let assessmentId = /*[[${assessment.id}]]*/[[${ assessment.id }]];
                $("#create-url-btn").prop('disabled', true);
                $("#create-url-feedback").text('Creating...');
                $.ajax({
                    url: '/assessment/' + assessmentId + '/create-url',
                    type: 'POST',
                    success: function (data) {
                        $("#create-url-feedback").html('<span style="color: green;">Created!</span>');
                        setTimeout(function(){
                            $("#create-url-feedback").empty();
                            $("#create-url-btn").prop('disabled', false);
                        }, 1800);

                        if(data && data.directUrl) {
                            $("#direct-url-link").attr('href', data.directUrl);
                            $("#direct-url-link").text(window.location.origin + data.directUrl);
                            $("#direct-url-row").show();

                            // Also update the Assessment URL row in the table
                            var $urlTd = $("th:contains('Assessment URL')").next('td');
                            if ($urlTd.length > 0) {
                                var anchor = $urlTd.find('a');
                                if (anchor.length > 0) {
                                    anchor.attr('href', data.directUrl);
                                    anchor.text(window.location.origin + data.directUrl);
                                    anchor.parent().show();
                                    anchor.parent().siblings('span').hide();
                                } else {
                                    // In case anchor didn't exist before (URL was not set initially)
                                    $urlTd.html('<span><a href="'+data.directUrl+'" target="_blank">' + window.location.origin + data.directUrl + '</a></span>');
                                }
                            }
                        }
                    },
                    error: function (err) {
                        $("#create-url-feedback").html('<span style="color: red;">Error creating URL</span>');
                        $("#create-url-btn").prop('disabled', false);
                    }
                });
            });
            let assessmentId = /*[[${assessment.id}]]*/[[${ assessment.id }]];
            function showSuccessIcon(container) {
                container.html('<span class="answer-success" title="Saved"><svg viewBox="0 0 18 18"><circle cx="9" cy="9" r="8" fill="#d8ffd8" stroke="#33aa33" stroke-width="2"/><path d="M5 9l3 3 5-5" fill="none" stroke="#33aa33" stroke-width="2"/></svg></span>');
            }
            function showErrorIcon(container) {
                container.html('<span class="answer-error" title="Error saving"><svg viewBox="0 0 18 18"><circle cx="9" cy="9" r="8" fill="#ffd8d8" stroke="#cc2222" stroke-width="2"/><path d="M6 6l6 6M12 6l-6 6" fill="none" stroke="#cc2222" stroke-width="2"/></svg></span>');
            }
            function clearIcon(container) {
                container.empty();
            }
            $('.answer-select').on('change', function () {
                var select = $(this);
                var controlId = select.data('control-id');
                var answerId = select.val();
                var feedbackIcon = select.closest('span').find('.answer-feedback');
                select.css('background', ''); // reset
                clearIcon(feedbackIcon);
                if (!answerId) {
                    clearIcon(feedbackIcon);
                    return;
                }
                if (assessmentId && controlId) {
                    $.post({
                        url: '/assessment/' + assessmentId + '/answer',
                        data: {
                            controlId: controlId,
                            answerId: answerId
                        },
                        success: function (response) {
                            select.css('background', '#d8ffd8');
                            showSuccessIcon(feedbackIcon);
                            setTimeout(function () { clearIcon(feedbackIcon); select.css('background', ''); }, 1500);
                        },
                        error: function (xhr) {
                            select.css('background', '#ffd8d8');
                            showErrorIcon(feedbackIcon);
                        }
                    });
                }
            });
        });

        function toggleDesc(btn) {
            var $tooltip = $(btn).siblings('.ctrl-desc-tooltip');
            // Hide any other visible tooltips first
            $('.ctrl-desc-tooltip').not($tooltip).fadeOut(120);
            $tooltip.fadeToggle(120);
        }
        // Hide tooltip when clicking outside
        $(document).on('mousedown keydown', function (e) {
            if (!$(e.target).closest('.ctrl-desc-wrap').length) {
                $('.ctrl-desc-tooltip').fadeOut(120);
            }
        });
    </script>
</body>

</html>
